{% extends "base.html" %} {% load crispy_forms_tags static %} {% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Secure Checkout</h2>

  <!-- Order Summary -->
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">ðŸ›’ Order Summary</div>
    <ul class="list-group list-group-flush">
      {% for item in basket_items %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          {{ item.plan.name }}
          <small class="text-muted"> Â£{{ item.plan.price }} Ã— {{ item.qty }} </small>
        </div>
        <strong>Â£{{ item.subtotal }}</strong>
      </li>
      {% endfor %}
    </ul>
    <div class="card-footer text-end fw-bold">Total to Pay: Â£{{ basket_total }}</div>
  </div>

  <!-- Payment Form -->
  <form method="post" id="payment-form" class="card shadow-sm p-4">
    {% csrf_token %} {{ form|crispy }}

    <!-- Stripe card element -->
    <div id="card-element" class="form-control mb-3"></div>
    <div id="card-errors" role="alert" class="text-danger mb-3"></div>

    <!-- hidden client_secret and payment_intent_id -->
    <input type="hidden" id="id_client_secret" value="{{ client_secret }}" />
    <input type="hidden" name="payment_intent_id" id="payment_intent_id" />

    <!-- optional save info -->
    <label class="mt-2 d-block"> <input type="checkbox" name="save_info" /> Save my info for next time </label>

    <button id="submit-btn" class="btn btn-success w-100 fw-bold">ðŸ’³ Pay Â£{{ basket_total }}</button>
  </form>
</div>

<!-- Loading overlay -->
<div id="loading-overlay">
  <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem">
    <span class="visually-hidden">Processing payment...</span>
  </div>
</div>
<script>
  const stripePublicKey = "{{ stripe_public_key }}";
  const cacheCheckoutUrl = "{% url 'cache_checkout_data' %}";
</script>
{% endblock %} {% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script src="{% static 'js/checkout.js' %}" defer></script>
{% endblock %}
