{% extends "base.html" %} {% load crispy_forms_tags %} {% block content %}
<div class="container mt-5">
  <h2 class="mb-4">Secure Checkout</h2>

  <!-- Order Summary -->
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">ðŸ›’ Order Summary</div>
    <ul class="list-group list-group-flush">
      {% for item in basket_items %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          {{ item.plan.name }}
          <small class="text-muted"> Â£{{ item.plan.price }} Ã— {{ item.qty }} </small>
        </div>
        <strong>Â£{{ item.subtotal }}</strong>
      </li>
      {% endfor %}
    </ul>
    <div class="card-footer text-end fw-bold">Total to Pay: Â£{{ basket_total }}</div>
  </div>

  <!-- Payment Form -->
  <form method="post" id="payment-form" class="card shadow-sm p-4">
    {% csrf_token %} {{ form|crispy }}

    <!-- Stripe card element -->
    <div id="card-element" class="form-control mb-3"></div>
    <div id="card-errors" role="alert" class="text-danger mb-3"></div>

    <!-- hidden field to carry Stripe PaymentIntent id -->
    <input type="hidden" name="payment_intent_id" id="payment_intent_id" />

    <button id="submit-btn" class="btn btn-success w-100 fw-bold">ðŸ’³ Pay Â£{{ basket_total }}</button>
  </form>
</div>

<!-- Loading overlay -->
<div id="loading-overlay">
  <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem">
    <span class="visually-hidden">Processing payment...</span>
  </div>
</div>

<style>
  #loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    z-index: 9999;
    display: none; /* hidden by default */
    align-items: center;
    justify-content: center;
  }
</style>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ stripe_public_key }}");
  const elements = stripe.elements();
  const card = elements.create("card", { style: { base: { fontSize: "16px" } } });
  card.mount("#card-element");

  card.on("change", function (event) {
    document.getElementById("card-errors").textContent = event.error ? event.error.message : "";
  });

  const form = document.getElementById("payment-form");
  const overlay = document.getElementById("loading-overlay");
  const payBtn = document.getElementById("submit-btn");

  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    // show overlay + disable button
    overlay.style.display = "flex";
    payBtn.disabled = true;

    const { paymentIntent, error } = await stripe.confirmCardPayment("{{ client_secret }}", {
      payment_method: { card: card },
    });

    if (error) {
      document.getElementById("card-errors").textContent = error.message;
      overlay.style.display = "none";
      payBtn.disabled = false;
    } else if (paymentIntent.status === "succeeded") {
      console.log("Stripe Succeeded âœ…", paymentIntent.id);
      document.getElementById("payment_intent_id").value = paymentIntent.id;
      form.submit(); // continue Django POST
    }
  });
</script>
{% endblock %}
