{% extends "base.html" %} {% load static %} {% block content %}
<div class="container py-4">
  <!-- Media Player -->
  <div
    id="player-card"
    data-tracks-url="{% url 'tracks_json' %}"
    data-log-play-url="{% url 'log_play' 0 %}"
    data-toggle-fav-url="{% url 'toggle_favorite' 0 %}"
  ></div>

  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex flex-column gap-2">
      <div class="d-flex align-items-center justify-content-between">
        <strong id="nowplaying">Idle</strong>
        <div class="btn-group" role="group" aria-label="Player controls">
          <button id="prev" type="button" class="btn btn-outline-secondary">‚èÆ</button>
          <button id="playpause" type="button" class="btn btn-primary">‚ñ∂ Play</button>
          <button id="next" type="button" class="btn btn-outline-secondary">‚è≠</button>
          <button id="shuffle" type="button" class="btn btn-outline-secondary" aria-pressed="false">üîÄ</button>
          <button id="check-all-global" type="button" class="btn btn-outline-success">‚úî All</button>
        </div>
      </div>

      <div class="d-flex gap-2 w-100">
        <div class="d-flex align-items-center gap-2 w-100">
          <span id="currenttime">0:00</span>
          <input id="progress" type="range" min="0" max="100" value="0" class="form-range" style="flex: 1" />
          <span id="duration">0:00</span>
        </div>

        <div class="d-flex align-items-center gap-2">
          <label for="volume" class="mb-0 small">Vol</label>
          <input id="volume" type="range" min="0" max="1" step="0.01" class="form-range" />
        </div>
      </div>

      <audio id="player" preload="metadata"></audio>
    </div>
  </div>

  {% if user.is_authenticated %}
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="my-album-tab" data-bs-toggle="tab" data-bs-target="#my-album" type="button">üéº My Playlist</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="my-fav-tab" data-bs-toggle="tab" data-bs-target="#my-fav" type="button">‚ù§Ô∏è My Favourites</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="recent-tab" data-bs-toggle="tab" data-bs-target="#recent" type="button">üïì Recently Played</button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    {# ------- üéº My Albums ------- #}
    <div class="tab-pane fade show active" id="my-album" role="tabpanel">
      <div id="albums" class="d-flex flex-column gap-3" data-reorder-url="{% url 'album:albums_reorder' %}">
        {% for album in albums %}
        <div class="album card" data-id="{{ album.id }}" data-reorder-url="{% url 'album:album_reorder_tracks' album.id %}" draggable="true">
          <div class="card-header d-flex align-items-center justify-content-between gap-2">
            <div class="d-flex align-items-center gap-2">
              <button
                class="btn btn-sm btn-link fw-bold text-decoration-none"
                data-bs-toggle="collapse"
                data-bs-target="#album-{{ album.id }}-collapse"
                aria-expanded="true"
                aria-controls="album-{{ album.id }}-collapse"
              >
                <span class="h5">‚Üï&nbsp;</span>{{ album.name }}&nbsp;‚ñº
              </button>

              <!-- ‚≠ê Album stars -->
              <div class="ms-1">
                {% include "ratings/_stars.html" with type="album" id=album.id avg=album.rating_avg count=album.rating_count user_rating=None %}
              </div>
            </div>

            <div class="form-check mb-0">
              <input class="form-check-input check-all" type="checkbox" />
              <label class="form-check-label">Check All</label>
            </div>
          </div>

          <div id="album-{{ album.id }}-collapse" class="collapse show">
            <ul class="list-group list-group-flush tracks">
              {% for at in album.album_tracks_annotated %}
              <li class="list-group-item d-flex align-items-center gap-2 track-item" data-atid="{{ at.id }}" data-id="{{ at.track.id }}" draggable="true">
                <input class="form-check-input track-check" type="checkbox" />

                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary play-btn"
                  data-id="{{ at.track.id }}"
                  data-name="{{ at.track.name }}"
                  data-src="{% if at.track.audio_file %}{{ at.track.audio_file.url }}{% else %}{{ at.track.source_url }}{% endif %}"
                >
                  ‚ñ∂
                </button>

                <span class="flex-grow-1">{{ at.track.name }}</span>

                <!-- ‚≠ê Track stars -->
                <span class="ms-2">
                  {% include "ratings/_stars.html" with type="track" id=at.track.id avg=at.track_avg count=at.track_count user_rating=None %}
                </span>

                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger fav-btn {% if at.is_favorited %}active{% endif %}"
                  data-track="{{ at.track.id }}"
                  aria-pressed="{{ at.is_favorited|yesno:'true,false' }}"
                >
                  {% if at.is_favorited %}‚ô•{% else %}‚ô°{% endif %}
                </button>

                <span class="track-playing-status ms-2"></span>
              </li>
              {% empty %}
              <li class="list-group-item text-muted">No tracks</li>
              {% endfor %}
            </ul>
          </div>
        </div>
        {% empty %}
        <p class="text-muted">No albums yet.</p>
        {% endfor %}
      </div>
    </div>

    {# ------- ‚ù§Ô∏è My Favourites ------- #}
    <div class="tab-pane fade" id="my-fav" role="tabpanel">
      <div class="album card mb-4" data-id="favorites">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>‚ô• Favourites</span>
          <div class="form-check mb-0">
            <input class="form-check-input check-all" type="checkbox" id="album-fav-all" />
            <label class="form-check-label" for="album-fav-all">Check All</label>
          </div>
        </div>

        <ul class="list-group list-group-flush tracks" id="fav-tracks" data-reorder-url="{% url 'favorites_reorder' %}">
          {% for track in favorites %}
          <li
            class="list-group-item d-flex align-items-center gap-2 track-item"
            data-id="{{ track.id }}"
            data-name="{{ track.name }}"
            data-src="{% if track.audio_file %}{{ track.audio_file.url }}{% elif track.source_url %}{{ track.source_url }}{% endif %}"
          >
            <span class="drag-handle" draggable="true" title="Drag to reorder">‚Üï</span>

            <input class="form-check-input track-check" type="checkbox" id="track-fav-{{ track.id }}" />

            <button
              type="button"
              class="btn btn-sm btn-outline-secondary play-btn"
              data-id="{{ track.id }}"
              data-name="{{ track.name }}"
              data-src="{% if track.audio_file %}{{ track.audio_file.url }}{% elif track.source_url %}{{ track.source_url }}{% endif %}"
            >
              ‚ñ∂
            </button>

            <span class="flex-grow-1">{{ track.name }}</span>

            <span class="ms-2">
              {% include "ratings/_stars.html" with type="track" id=track.id avg=track.rating_avg count=track.rating_count user_rating=None %}
            </span>

            <button
              type="button"
              class="btn btn-sm btn-outline-danger fav-btn {% if track.is_favorited %}active{% endif %}"
              data-track="{{ track.id }}"
              aria-pressed="{{ track.is_favorited|yesno:'true,false' }}"
            >
              {% if track.is_favorited %}‚ô•{% else %}‚ô°{% endif %}
            </button>
          </li>
          {% empty %}
          <li class="list-group-item text-muted">No favourites yet.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    {# ------- üïì Recently Played ------- #}
    <div class="tab-pane fade" id="recent" role="tabpanel">
      {% if user.is_authenticated %}
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Recently Played</h5>
          <button id="clear-recent"
                  data-url="{% url 'clear_recent' %}"
                  class="btn btn-sm btn-outline-danger">
            Clear All
          </button>
        </div>
      {% endif %}

      <ul id="recent-list" class="list-group list-group-flush tracks">
        {% for row in recent %}
          <li class="list-group-item d-flex align-items-center gap-2">
            <button
              class="btn btn-sm btn-outline-secondary play-btn"
              data-id="{{ row.id }}"
              data-name="{{ row.name }}"
              data-src="{% if row.audio_file %}{{ row.audio_file.url }}{% else %}{{ row.source_url }}{% endif %}">
              ‚ñ∂
            </button>

            <span class="flex-grow-1">{{ row.name }}</span>

            <span class="ms-2">
              {% include "ratings/_stars.html" with type="track" id=row.id avg=row.rating_avg count=row.rating_count user_rating=None %}
            </span>

            <button
              class="btn btn-sm btn-outline-danger fav-btn {% if row.is_favorited %}active{% endif %}"
              data-track="{{ row.id }}"
              aria-pressed="{{ row.is_favorited|yesno:'true,false' }}">
              {% if row.is_favorited %}‚ô•{% else %}‚ô°{% endif %}
            </button>
          </li>
        {% empty %}
          <li class="list-group-item text-muted">No recently played tracks.</li>
        {% endfor %}
      </ul>
    </div>

  </div>
  {% endif %}
</div>
{% endblock %} {% block extra_js %}
<script src="{% static 'js/cookies.js' %}" defer></script>
<script src="{% static 'js/music_player.js' %}" defer></script>
<script src="{% static 'js/track_list.js' %}" defer></script>
<script src="{% static 'js/toggle_fav_btn.js' %}" defer></script>
{% endblock %}
