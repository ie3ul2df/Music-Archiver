{% extends "base.html" %} {% load static %} {% block content %}
<div class="container py-4">
  <!-- Config element for external JS (URLs via data-attrs) -->
  <div
    id="player-card"
    data-tracks-url="{% url 'tracks_json' %}"
    data-toggle-fav-url="{% url 'toggle_favorite' 0 %}"
    data-log-play-url="{% url 'log_play' 0 %}"
  ></div>

  {# --------------- Media Player --------------- #}
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex flex-column gap-2">
      <div class="d-flex align-items-center justify-content-between">
        <strong id="nowplaying">Idle</strong>
        <div class="btn-group" role="group" aria-label="Player controls">
          <button id="prev" type="button" class="btn btn-outline-secondary">‚èÆ</button>
          <button id="playpause" type="button" class="btn btn-primary">‚ñ∂ Play</button>
          <button id="next" type="button" class="btn btn-outline-secondary">‚è≠</button>
          <button id="shuffle" type="button" class="btn btn-outline-secondary" aria-pressed="false">üîÄ</button>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <span id="currenttime">0:00</span>
        <input id="progress" type="range" min="0" max="100" value="0" class="form-range" style="flex: 1" />
        <span id="duration">0:00</span>
      </div>

      <div class="d-flex align-items-center gap-2">
        <label for="volume" class="mb-0 small">Vol</label>
        <input id="volume" type="range" min="0" max="1" step="0.01" class="form-range" style="max-width: 220px" />
      </div>

      <!-- The actual audio element the JS binds to -->
      <audio id="player" preload="metadata"></audio>
    </div>
  </div>

  {% if user.is_authenticated %}
  <h3 class="mb-2">Your recently listened tracks</h3>
  <ul class="list-group mb-4">
    {% for t in recent_tracks %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary play-btn"
          data-id="{{ t.id }}"
          data-name="{{ t.name }}"
          data-src="{% if t.audio %}{{ t.audio.url }}{% elif t.audio_file %}{{ t.audio_file.url }}{% elif t.file %}{{ t.file.url }}{% elif t.source_url %}{{ t.source_url }}{% endif %}"
          aria-label="Play {{ t.name }}"
        >
          ‚ñ∂
        </button>
        <span>{{ t.name }}</span>
      </div>

      <button
        type="button"
        class="btn btn-sm btn-outline-danger fav-btn {% if t.id in favorite_ids %}active{% endif %}"
        data-track="{{ t.id }}"
        aria-pressed="{% if t.id in favorite_ids %}true{% else %}false{% endif %}"
        aria-label="{% if t.id in favorite_ids %}Remove from favourites{% else %}Add to favourites{% endif %}"
        title="{% if t.id in favorite_ids %}Remove from favourites{% else %}Add to favourites{% endif %}"
      >
        {% if t.id in favorite_ids %}‚ô•{% else %}‚ô°{% endif %}
      </button>
    </li>
    {% empty %}
    <li class="list-group-item text-muted">Nothing yet ‚Äî start listening!</li>
    {% endfor %}
  </ul>

  <h3 class="mb-2">Your favourite tracks</h3>
  <ul class="list-group mb-4" data-fav-list>
    {% for t in favourite_tracks %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary play-btn"
          data-id="{{ t.id }}"
          data-name="{{ t.name }}"
          data-src="{% if t.audio %}{{ t.audio.url }}{% elif t.audio_file %}{{ t.audio_file.url }}{% elif t.file %}{{ t.file.url }}{% elif t.source_url %}{{ t.source_url }}{% endif %}"
          aria-label="Play {{ t.name }}"
        >
          ‚ñ∂
        </button>
        <span>{{ t.name }}</span>
      </div>

      <button
        type="button"
        class="btn btn-sm btn-outline-danger fav-btn active"
        data-track="{{ t.id }}"
        aria-pressed="true"
        aria-label="Remove from favourites"
        title="Remove from favourites"
      >
        ‚ô•
      </button>
    </li>
    {% empty %}
    <li class="list-group-item text-muted">No favourites yet ‚Äî tap ‚ô• to add some.</li>
    {% endfor %}
  </ul>
  {% endif %}

  <h3 class="mb-2">All tracks</h3>
  <ul class="list-group">
    {% for t in tracks %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-2">
        <button
          type="button"
          class="btn btn-sm btn-outline-secondary play-btn"
          data-id="{{ t.id }}"
          data-name="{{ t.name }}"
          data-src="{% if t.audio %}{{ t.audio.url }}{% elif t.audio_file %}{{ t.audio_file.url }}{% elif t.file %}{{ t.file.url }}{% elif t.source_url %}{{ t.source_url }}{% endif %}"
          aria-label="Play {{ t.name }}"
        >
          ‚ñ∂
        </button>
        <span>{{ t.name }}</span>
      </div>

      {% if user.is_authenticated %}
      <button
        type="button"
        class="btn btn-sm btn-outline-danger fav-btn {% if t.id in favorite_ids %}active{% endif %}"
        data-track="{{ t.id }}"
        aria-pressed="{% if t.id in favorite_ids %}true{% else %}false{% endif %}"
        aria-label="{% if t.id in favorite_ids %}Remove from favourites{% else %}Add to favourites{% endif %}"
        title="{% if t.id in favorite_ids %}Remove from favourites{% else %}Add to favourites{% endif %}"
      >
        {% if t.id in favorite_ids %}‚ô•{% else %}‚ô°{% endif %}
      </button>
      {% endif %}
    </li>
    {% empty %}
    <li class="list-group-item text-muted">No tracks available.</li>
    {% endfor %}
  </ul>
</div>
{% endblock %} {% block extra_js %}
<script src="{% static 'js/cookies.js' %}" defer></script>
<script src="{% static 'js/toggle_fav_btn.js' %}" defer></script>
<script src="{% static 'js/music_player.js' %}" defer></script>
{% endblock %}
