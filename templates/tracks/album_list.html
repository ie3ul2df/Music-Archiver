{% extends "base.html" %} {% block content %}
<div class="container py-4">
  <h3>Albums</h3>

  <form id="add-album-form" class="d-flex gap-2 mb-3">
    {% csrf_token %}
    <input type="text" name="name" class="form-control" placeholder="New album name" required />
    <button class="btn btn-primary">Add</button>
  </form>

  <ul id="album-list" class="list-group">
    {% for a in albums %}
    <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ a.id }}">
      <span class="album-name">{{ a.name }}</span>
      <div class="btn-group">
        <button class="btn btn-sm btn-outline-secondary rename-btn">‚úè</button>
        <button class="btn btn-sm btn-outline-danger delete-btn">üóë</button>
      </div>
    </li>
    {% endfor %}
  </ul>
</div>

<script>
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  // Add album
  document.getElementById("add-album-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = e.target.name.value.trim();
    if (!name) return;

    const resp = await fetch("{% url 'ajax_add_album' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrfToken },
      body: new URLSearchParams({ name }),
    });
    const data = await resp.json();
    if (data.ok) {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.dataset.id = data.id;
      li.innerHTML = `<span class="album-name">${data.name}</span>
      <div class="btn-group">
        <button class="btn btn-sm btn-outline-secondary rename-btn">‚úè</button>
        <button class="btn btn-sm btn-outline-danger delete-btn">üóë</button>
      </div>`;
      document.getElementById("album-list").appendChild(li);
      e.target.reset();
    } else {
      alert(data.error);
    }
  });

  // Delegate rename & delete
  document.getElementById("album-list").addEventListener("click", async (e) => {
    const li = e.target.closest("li[data-id]");
    if (!li) return;
    const id = li.dataset.id;

    if (e.target.classList.contains("rename-btn")) {
      const newName = prompt("Rename album:", li.querySelector(".album-name").textContent);
      if (!newName) return;
      const resp = await fetch(`/tracks/albums/${id}/rename/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
        body: new URLSearchParams({ name: newName }),
      });
      const data = await resp.json();
      if (data.ok) {
        li.querySelector(".album-name").textContent = data.name;
      } else {
        alert(data.error);
      }
    }

    if (e.target.classList.contains("delete-btn")) {
      if (!confirm("Delete this album?")) return;
      const resp = await fetch(`/tracks/albums/${id}/delete/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken },
      });
      const data = await resp.json();
      if (data.ok) {
        li.remove();
      } else {
        alert("Error deleting album.");
      }
    }
  });
</script>
{% endblock %}
