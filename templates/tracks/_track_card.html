{# templates/tracks/_track_card.html #}
{# expects: track, (optional) album, (optional) album_item_id, (optional) is_owner #}

<li class="list-group-item p-2 track-card d-flex flex-column gap-2"
    {% if album_item_id %} data-id="{{ album_item_id }}" draggable="{% if is_owner %}true{% else %}false{% endif %}"{% endif %}
    data-track-id="{{ track.id }}">
  <div class="d-flex align-items-center gap-2 flex-wrap">
    
    <!-- Title -->
    <span class="fw-semibold me-1">
      {% if album_item_id and at.custom_name %}
        {{ at.custom_name }}
      {% else %}
        {{ track.name }}
      {% endif %}
    </span>


    <!-- Album link (if provided) -->
    {% if album %}
      <a class="text-decoration-none small text-muted" href="{% url 'album:album_detail' album.id %}">· {{ album.name }}</a>
    {% endif %}

    <!-- Author link -->
    <a class="text-decoration-none small text-muted" href="{% url 'user_tracks' track.owner.username %}">· {{ track.owner.username }}</a>

    <!-- Actions -->
    <span class="ms-auto d-flex align-items-center gap-1">

      <!-- Favourite -->
        <button class="btn btn-sm {% if is_favorited %}btn-danger{% else %}btn-outline-danger{% endif %} js-fav"
                data-url="{% url 'toggle_favorite' track.id %}" title="Favourite">♥</button>

      <!-- Manage the tracks -->
      {% if request.user.is_authenticated %}
        <button class="btn btn-sm btn-outline-secondary js-save"
                data-save-url="{% url 'save_system:save_track' track.id %}"
                data-bs-toggle="modal" data-bs-target="#saveToAlbumModal"
                title="Save to one of my albums">
          {% if track.is_in_my_albums %}🗃️{% else %}💾{% endif %}
        </button>
      {% endif %}

      <!-- Download -->
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'download_track' track.id %}" title="Download">⬇</a>

      <!-- Play -->
      <button class="btn btn-sm btn-primary js-inline-play" title="Play/Pause">▶</button>

      <!-- Rating (use pre-rendered html in album views, or fallback include) -->
      <span class="ms-1 rating-wrap">
        {% if at and at.rating_html %}{{ at.rating_html|safe }}
        {% else %}
          {% include "ratings/_stars.html" with type="track" id=track.id avg=avg|default:0 count=count|default:0 user_rating=None %}
        {% endif %}
      </span>

      {# Owner-only tools on album page: ✏ 🗑 ⛔ #}
      {% if is_owner %}

        <!-- Rename (opens existing modal on album page) -->
        <button type="button" class="btn btn-sm btn-outline-secondary rename-track-btn"
        data-track-id="{{ album_item_id }}" data-track-name="{{ track.name }}"
        data-bs-toggle="modal" data-bs-target="#renameTrackModal">✏</button>

        <!-- 🗑 Delete my track entirely (only if I own it) -->
        {% if track.is_my_track %}
          <button type="button"
                  class="btn btn-sm btn-outline-danger delete-track-btn"
                  data-track-id="{{ track.id }}"
                  data-track-name="{{ track.name }}"
                  data-bs-toggle="modal"
                  data-bs-target="#deleteTrackModal">🗑</button>
        {% endif %}


        <!-- ⛔ Detach from THIS album (requires album_item_id) -->
        {% if album and album_item_id %}
          <button type="button"
                  class="btn btn-sm btn-outline-warning js-detach"
                  data-detach-url="{% url 'album:album_detach_track' album.id album_item_id %}"
                  title="Remove from this album">⛔</button>
        {% endif %}

      {% endif %}
      
    </span>
  </div>

  <!-- Inline audio -->
  {% if track.audio_file %}
    <audio class="inline-audio d-none" preload="none"
           src="{{ track.audio_file.url }}" data-log-url="{% url 'log_play' track.id %}"></audio>
  {% elif track.source_url %}
    <audio class="inline-audio d-none" preload="none"
           src="{{ track.source_url }}" data-log-url="{% url 'log_play' track.id %}"></audio>
  {% endif %}
</li>
