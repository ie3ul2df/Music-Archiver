{# templates/tracks/_track_card.html #}
{# expects: track, (optional) album, (optional) album_item_id, (optional) is_owner, optionally: is_favorited (bool), in_playlist (bool), show_checkbox (bool) #}

<li class="list-group-item p-2 track-card track-item d-flex flex-column gap-2"
    data-id="{% if album_item_id %}{{ album_item_id }}{% elif playlist_item_id %}{{ playlist_item_id }}{% else %}{{ track.id }}{% endif %}"
    data-track-id="{{ track.id }}"
    draggable="true">
  <div class="d-flex align-items-center gap-2 flex-wrap">
    {% if allow_reorder %}
      <span class="drag-handle me-2" title="Drag to reorder">☰</span>
    {% endif %}

    {% if show_checkbox %}
      <input class="form-check-input track-check"
            type="checkbox"
            value="{{ track.id }}"
            aria-label="Select {{ track.name }}">
    {% endif %}

    <!-- Title -->
    <span class="fw-semibold me-1" data-role="track-title">
      {% if display_name %}
        {{ display_name }}
      {% elif at and at.custom_name %}
        {{ at.custom_name }}
      {% else %}
        {{ track.name }}
      {% endif %}
    </span>

    {% if album %}
      <a class="text-decoration-none small text-muted" href="{% url 'album:album_detail' album.id %}">· {{ album.name }}</a>
    {% endif %}

    <a class="text-decoration-none small text-muted"
      href="{% url 'profile:public_profile' track.owner.username %}">
      🔗 by <span class="fw-bold"> {{ track.owner.username }} </span>
    </a>
    <!-------------- Actions -------------->
    <span class="ms-auto d-flex align-items-center gap-1">

      {# ★ Rankings #}
      <span class="ms-1 rating-wrap">
        {% if at and at.rating_html %}{{ at.rating_html|safe }}
        {% else %}
          {% with base_avg=track.rating_avg|default:0 base_count=track.rating_count|default:0 %}
            {% if avg != '' or count != '' %}
              {% include "ratings/_stars.html" with type="track" id=track.id avg=avg|default:base_avg count=count|default:base_count user_rating=None %}
            {% elif at %}
              {% include "ratings/_stars.html" with type="track" id=track.id avg=at.track_avg|default:base_avg count=at.track_count|default:base_count user_rating=None %}
            {% else %}
              {% include "ratings/_stars.html" with type="track" id=track.id avg=base_avg count=base_count user_rating=None %}
            {% endif %}
          {% endwith %}
        {% endif %}
      </span>

      {# ▶ Play/Pause #}
      <div class="d-flex align-items-center gap-2">
        <button
          class="btn btn-lg border-0 fs-3 js-inline-play"
          title="Play/Pause"
          aria-pressed="false"
          data-id="{{ track.id }}"
          {% if display_name %}data-name="{{ display_name }}"
          {% elif at and at.custom_name %}data-name="{{ at.custom_name }}"
          {% else %}data-name="{{ track.name }}"
          {% endif %}
        >▶</button>
        <div class="track-inline-progress d-none d-flex align-items-center gap-1 small text-muted" aria-hidden="true">
          <span class="track-current">0:00</span>
          <input
            type="range"
            class="form-range track-progress mb-0 flex-shrink-0"
            min="0"
            max="100"
            step="0.1"
            value="0"
            aria-label="Seek within track"
            style="width: 110px; min-width: 80px;">
          <span class="track-duration">0:00</span>
        </div>
      </div>

      <div class="dropdown">
        <button class="btn btn-sm dropdown-toggle action-dropdown-menu" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" aria-expanded="false"></button>
        <ul class="dropdown-menu action-dropdown-menu" aria-labelledby="dropdownMenu2">
          {% if request.user.is_authenticated %}  
            {# ♥ Favourite #}
            {% with fav=is_favorited %}
            <li class="m-2 d-flex justify-content-center">
              <button
                class="btn btn-lg rounded-circle {% if fav %}btn-danger{% else %}btn-outline-danger{% endif %} js-fav"
                data-url="{% url 'toggle_favorite' track.id %}"
                title="Favourite"
                aria-pressed="{{ fav|yesno:'true,false' }}">
                {% if fav %}♥{% else %}♡{% endif %}
              </button>
            </li>
            {% endwith %}
          
            <li class="m-2 d-flex justify-content-center">
              
              <button class="btn btn-outline-info btn-lg border-0 js-save"
                      data-save-url="{% url 'save_system:save_track' track.id %}"
                      data-bs-toggle="modal" data-bs-target="#saveToAlbumModal"
                      title="Save to one of my albums">
                {% if track.owner_id == request.user.id or track.is_in_my_albums %}🗃️{% else %}💾{% endif %}
              </button>
            </li>
            {% endif %}

            <li class="m-2 d-flex justify-content-center">
              
              <a class="btn btn-lg btn-outline-secondary border-0" href="{% url 'download_track' track.id %}" title="Download">⬇</a>
            </li>

            {% if is_owner and album and album_item_id %}
            <li class="m-2 d-flex justify-content-center">
              
              <button type="button"
                      class="btn btn-lg btn-outline-secondary border-0 rename-track-btn"
                      data-url="{% url 'album:album_rename_track' album.id album_item_id %}"
                      data-track-name="{% if at and at.custom_name %}{{ at.custom_name }}{% else %}{{ track.name }}{% endif %}"
                      data-bs-toggle="modal"
                      data-bs-target="#renameTrackModal">✏</button>
            </li>

              {% if track.is_my_track %}
              
              <li class="m-2 d-flex justify-content-center">
                <button type="button"
                        class="btn btn-lg btn-outline-danger delete-track-btn border-0"
                        data-track-id="{{ track.id }}"
                        data-track-name="{{ track.name }}"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteTrackModal">🗑</button>
              </li>
              {% endif %}

              <li class="m-2 d-flex justify-content-center">
              
              <button type="button"
                      class="btn btn-lg btn-outline-warning border-0 js-detach"
                      data-detach-url="{% url 'album:album_detach_track' album.id album_item_id %}"
                      title="Remove from this album">⛔</button>
              </li>
            {% endif %}
          
          {# ➕ / ✓ In — playlist toggle (always render; JS normalizes) #}
          {% with inpl=in_playlist %}
          <li class="m-2 d-flex justify-content-center">
            
            <button
              type="button"
              class="btn btn-lg add-to-playlist {% if inpl %}btn-success{% else %}btn-outline-success{% endif %} border-0"
              {# avoid duplicate ids; either drop id or make it unique: #}
              id="add-to-playlist-{{ track.id }}{% if album_item_id %}-{{ album_item_id }}{% endif %}"
              data-track="{{ track.id }}"
              data-url="{% url 'playlist:toggle' track.id %}"
              data-in="{% if inpl %}1{% else %}0{% endif %}"
              aria-pressed="{{ inpl|yesno:'true,false' }}">
              {% if inpl %}✓{% else %}➕{% endif %}
            </button>
          </li>
          {% endwith %}
        </ul>
      </div>
      
    </span>

  </div>

  {% if track.audio_file %}
    <audio class="inline-audio d-none" preload="none"
           src="{{ track.audio_file.url }}" data-log-url="{% url 'log_play' track.id %}"></audio>
  {% elif track.source_url %}
    <audio class="inline-audio d-none" preload="none"
           src="{{ track.source_url }}" data-log-url="{% url 'log_play' track.id %}"></audio>
  {% endif %}
</li>
