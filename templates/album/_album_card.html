{# templates/album/_album_card.html #}
<li class="album list-group-item d-flex justify-content-between align-items-center flex-wrap"
    data-id="{{ album.pk }}"
    data-reorder-url="{% if reorder_url %}{{ reorder_url }}{% else %}{% url 'album:album_reorder_tracks' album.pk %}{% endif %}">

  <div class="d-flex flex-column flex-grow-1">

    {# --- Owner CRUD (unchanged) --- #}
    {% if request.user.is_authenticated and request.user.id == album.owner_id %}
      {% if request.resolver_match.url_name != "home" %}
        <div class="btn-group btn-group-sm mt-2 mt-md-0" role="group">
          <a href="{% url 'album:album_detail' album.pk %}" class="btn btn-outline-primary">👁 View</a>

          {# ✏ Edit — only if we have a valid URL #}
          {% if rename_url %}
            <button type="button"
                    class="btn btn-outline-secondary rename-album-btn"
                    data-bs-toggle="modal"
                    data-bs-target="#renameAlbumModal"
                    data-url="{{ rename_url }}"
                    data-current-name="{{ album.name }}">
              ✏ Edit
            </button>
          {% endif %}

          {% if toggle_visibility_url %}
            <a href="{{ toggle_visibility_url }}" class="btn btn-outline-warning">
              {% if album.is_public %}🔒 Make Private{% else %}🌍 Make Public{% endif %}
            </a>
          {% endif %}

          {% if delete_url %}
            <button type="button"
                    class="btn btn-outline-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteAlbumModal"
                    data-url="{{ delete_url }}"
                    data-album-name="{{ album.name }}">
              🗑 Delete
            </button>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}


    {# --- Album header --- #}
    <div class="mt-2">
    <div class="mt-2">
      <a href="{% url 'album:album_detail' album.pk %}"
        class="fw-bold text-decoration-none"
        id="album-name-{{ album.id }}"
        data-role="album-name">
        {{ album.name }}
      </a>
      {% if album.is_public %}
        <span class="badge bg-success ms-2">Public</span>
      {% else %}
        <span class="badge bg-secondary ms-2">Private</span>
      {% endif %}
    </div>

    {# --- Owner link --- #}
    {% if album.owner %}
      <div class="small text-muted">
        <a class="text-decoration-none small text-muted"
           href="{% if owner_url %}{{ owner_url }}{% else %}{% url 'user_tracks' album.owner.username %}{% endif %}">
          🔗 {{ album.owner.username }}
        </a>
      </div>
    {% endif %}

    {# --- Stars --- #}
    <div class="mt-1">
      {% include "ratings/_stars.html" with type="album" id=album.id avg=album.rating_avg count=album.rating_count user_rating=None %}
    </div>

    {% if show_search %}
      <div class="input-group mt-3" data-album-search="{{ album.id }}">
        <span class="input-group-text">🔎</span>
        <input
          type="search"
          class="form-control album-track-search"
          placeholder="Search tracks in this album"
          aria-label="Search tracks in this album"
          data-target="#album-tracklist-{{ album.id }}">
        <button class="btn btn-outline-secondary album-track-search-clear" type="button">Clear</button>
      </div>
    {% endif %}

    {# --- Bulk mini-toolbar (for any signed-in user) --- #}
    {% if request.user.is_authenticated %}
      <div class="d-flex align-items-center gap-2 mt-3 flex-wrap">
        <div class="form-check me-2">
          <input class="form-check-input check-all" type="checkbox" id="check-all-{{ album.id }}">
          <label class="form-check-label small" for="check-all-{{ album.id }}">Select all</label>
        </div>

        <button type="button"
                class="btn btn-sm btn-outline-success js-add-selected"
                data-url="{% url 'playlist:bulk_add' %}"
                title="Add selected tracks to playlist">
          ➕ Add to playlist
        </button>

        <button type="button"
                class="btn btn-sm btn-outline-secondary js-save-selected"
                data-save-url="{% url 'save_system:bulk_save_tracks' %}"
                data-bs-toggle="modal"
                data-bs-target="#saveToAlbumModal">
          💾 Save to album
        </button>

        {% if request.user.is_authenticated and request.user.id == album.owner_id %}
          <button type="button"
                  class="btn btn-sm btn-outline-danger js-remove-selected"
                  data-url="{% url 'album:album_bulk_detach' album.id %}"
                  title="Remove selected tracks from this album">
            ⛔ Remove selected
          </button>
        {% endif %}

      </div>
    {% endif %}

    {# --- Track list --- #}
    {% with ats=album.album_tracks_annotated|default:album.album_tracks.all %}
      {% if ats|length %}
        <ul
          class="list-group mt-2 album-tracklist"
          id="album-tracklist-{{ album.id }}"
          data-album-id="{{ album.id }}"
          {% if tracks_url %} data-tracks-url="{{ tracks_url }}"{% endif %}
          {% if reorder_url %} data-reorder-url="{{ reorder_url }}"{% endif %}
        >
          {# Render server-side as a fallback (or keep empty if you always lazy-load) #}
          {% for at in ats %}
            {% with fav=at.is_favorited inpl=at.track.in_playlist|default:False avg=at.track_avg|default:0 cnt=at.track_count|default:0 is_owner=request.user.id|yesno:"True,False" %}
              {% if request.user.id == album.owner.id %}
                {% include "tracks/_track_card.html" with track=at.track album=album album_item_id=at.id is_owner=True at=at show_checkbox=True is_favorited=fav in_playlist=inpl avg=avg count=cnt %}
              {% else %}
                {% include "tracks/_track_card.html" with track=at.track album=album album_item_id=at.id is_owner=False at=at show_checkbox=True is_favorited=fav in_playlist=inpl avg=avg count=cnt %}
              {% endif %}
            {% endwith %}
          {% endfor %}
        </ul>
      {% else %}
        <div class="small text-muted mt-2">No tracks in this album yet.</div>
      {% endif %}
    {% endwith %}

</li>
