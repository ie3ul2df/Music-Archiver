{% extends "base.html" %}{% block content %}
<div class="container py-4">
  <h2>{{ playlist.name }}</h2>

  <form action="{% url 'playlist_add_track' playlist.pk %}" method="post" class="d-flex gap-2 my-3">
    {% csrf_token %}
    <select name="track_id" class="form-select" required>
      <option value="">Add a trackâ€¦</option>
      {% for t in user_tracks %}
      <option value="{{ t.id }}">{{ t.name }}</option>
      {% endfor %}
    </select>
    <button class="btn btn-primary">Add</button>
  </form>

  <p class="text-muted">Drag to change order</p>
  <ul id="pl-items" class="list-group">
    {% for it in items %}
    <li class="list-group-item" draggable="true" data-id="{{ it.id }}">{{ it.track.name }}</li>
    {% empty %}
    <li class="list-group-item">No tracks yet.</li>
    {% endfor %}
  </ul>
</div>
<script>
  (function () {
    const ul = document.getElementById("pl-items");
    let dragging;
    ul.addEventListener("dragstart", (e) => {
      dragging = e.target.closest("li");
    });
    ul.addEventListener("dragover", (e) => {
      e.preventDefault();
      const li = e.target.closest("li");
      if (!li || li === dragging) return;
      const rect = li.getBoundingClientRect();
      const after = e.clientY - rect.top > rect.height / 2;
      ul.insertBefore(dragging, after ? li.nextSibling : li);
    });
    ul.addEventListener("drop", () => {
      const order = Array.from(ul.querySelectorAll("li")).map((li) => parseInt(li.dataset.id));
      fetch("{% url 'playlist_reorder' playlist.pk %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ order }),
      });
    });
  })();
</script>
{% endblock %}
