{% extends "base.html" %} 
{% load static %} 
{% block content %}

<div class="container py-4">
  <!-- Tabs -->
  <ul class="nav nav-tabs" id="albumsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button
        class="nav-link active"
        id="your-tab"
        data-bs-toggle="tab"
        data-bs-target="#your-tabpane"
        type="button"
        role="tab"
        aria-controls="your-tabpane"
        aria-selected="true"
      >
        Your Albums
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="saved-albums-tab"
        data-bs-toggle="tab"
        data-bs-target="#saved-albums-tabpane"
        type="button"
        role="tab"
        aria-controls="saved-albums-tabpane"
        aria-selected="false"
      >
        Saved Albums
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button
        class="nav-link"
        id="saved-tracks-tab"
        data-bs-toggle="tab"
        data-bs-target="#saved-tracks-tabpane"
        type="button"
        role="tab"
        aria-controls="saved-tracks-tabpane"
        aria-selected="false"
      >
        Saved Tracks
      </button>
    </li>
  </ul>

  <div class="tab-content pt-3" id="albumsTabsContent">
    <!-- ================= Your Albums ================= -->
    <div class="tab-pane fade show active" id="your-tabpane" role="tabpanel" aria-labelledby="your-tab" tabindex="0">
      <!-- Header with search + create -->
      <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <h2 class="mb-0">Your Albums</h2>

        <div class="container">
          <div class="row">

            <div class="col-9">
              <!-- Search form -->
              <div class="input-group mb-3" id="album-search"
                  data-search-url="{% url 'album:unified_search' %}">
                <span class="input-group-text">ðŸ”Ž</span>
                <input
                  type="search"
                  class="form-control js-unified-search"
                  placeholder="Search Tracks & Albums..."
                  aria-label="Search albums"
                  data-target="#album-list">
                <button class="btn btn-outline-secondary js-unified-search-clear" type="button">Clear</button>
              </div>
            </div>

            <div class="col-3">
              <!-- Create new album (AJAX) -->
              <form id="album-create-form" action="{% url 'album:ajax_add_album' %}" method="post" class="d-flex gap-2">
                {% csrf_token %}
                <input name="name" class="form-control" placeholder="New album name" required aria-label="New album name" />
                <button class="btn btn-outline-primary" type="submit"><span>âž•</span>&nbspCreate</button>
              </form>
            </div>

          </div>
        </div>

      </div>

      <!-- Album list -->
      <ul id="album-list" class="list-group"
          data-reorder-url="{% url 'album:ajax_reorder_albums' %}">
        {% for a in albums %}

          {% url 'user_tracks' a.owner.username as owner_url %}
          {% url 'album:album_tracks_fragment' a.pk as tracks_url %}
          {% url 'album:ajax_rename_album' a.pk as rename_url %}
          {% url 'album:toggle_album_visibility' a.pk as toggle_visibility_url %}
          {% url 'album:ajax_delete_album' a.pk as delete_url %}

          {% include "album/_album_card.html" with album=a owner_url=owner_url tracks_url=tracks_url rename_url=rename_url toggle_visibility_url=toggle_visibility_url delete_url=delete_url allow_reorder=False show_search=False %}
        
        {% empty %}
          <li class="list-group-item">No albums yet.</li>
        {% endfor %}
      </ul>
      
    </div>

    <!-- ================= Saved Albums ================= -->
    <div class="tab-pane fade" id="saved-albums-tabpane" role="tabpanel" aria-labelledby="saved-albums-tab" tabindex="0">
      <h2 class="h4 mb-3">Saved Albums</h2>

      <div class="input-group mb-3" data-saved-search="albums">
        <span class="input-group-text">ðŸ”Ž</span>
        <input type="search" class="form-control saved-search-input" placeholder="Search saved albums" data-target="#saved-albums-list">
        <button class="btn btn-outline-secondary saved-search-clear" type="button">Clear</button>
      </div>

      <ul class="list-group" id="saved-albums-list">
        {% for s in saved_albums %}
          {% if s.original_album %}
            {% url 'user_tracks' s.original_album.owner.username as owner_url %}
            {% url 'album:album_tracks_fragment' s.original_album.pk as tracks_url %}
            {% url 'album:ajax_rename_album' s.original_album.pk as rename_url %}
            {% url 'album:toggle_album_visibility' s.original_album.pk as toggle_visibility_url %}
            {% url 'album:ajax_delete_album' s.original_album.pk as delete_url %}
            {% include "album/_album_card.html" with album=s.original_album owner_url=owner_url tracks_url=tracks_url rename_url=rename_url toggle_visibility_url=toggle_visibility_url delete_url=delete_url %}
          {% else %}
            <li class="list-group-item"><span class="fw-semibold">{{ s.name_snapshot }}</span> <small class="text-danger ms-2">Original removed</small></li>
          {% endif %}
        {% empty %}
          <li class="list-group-item">No saved albums.</li>
        {% endfor %}
      </ul>

    </div>

    <!-- ================= Saved Tracks ================= -->
    <div class="tab-pane fade" id="saved-tracks-tabpane" role="tabpanel" aria-labelledby="saved-tracks-tab" tabindex="0">
      <h2 class="h4 mb-3">Saved Tracks</h2>

      <div class="input-group mb-3" data-saved-search="tracks">
        <span class="input-group-text">ðŸ”Ž</span>
        <input type="search" class="form-control saved-search-input" placeholder="Search saved tracks" data-target="#saved-tracks-list">
        <button class="btn btn-outline-secondary saved-search-clear" type="button">Clear</button>
      </div>

      <ul class="list-group" id="saved-tracks-list">
        {% for s in saved_tracks %}
          {% if s.original_track %}
            {% with fav=s.original_track.is_favorited|default:False inpl=s.original_track.in_playlist|default:False avg=s.original_track.rating_avg|default:0 cnt=s.original_track.rating_count|default:0 %}
              {% include "tracks/_track_card.html" with track=s.original_track album=s.album album_item_id=None is_owner=False at=None show_checkbox=False is_favorited=fav in_playlist=inpl avg=avg count=cnt display_name=s.name_snapshot|default:s.original_track.name %}  
            {% endwith %}
          {% else %}
            <li class="list-group-item"><span class="fw-semibold">{{ s.name_snapshot }}</span> <small class="text-danger ms-2">Original removed</small></li>
          {% endif %}
        {% empty %}
          <li class="list-group-item">No saved tracks.</li>
        {% endfor %}
      </ul>
    </div>

  </div>
</div>

{% endblock %} 

{% block extra_js %}
<script src="{% static 'js/album_utils.js' %}" defer></script>
<script src="{% static 'js/album_list.js' %}" defer></script>
<script src="{% static 'js/album_tracks_loader.js' %}" defer></script>
{% endblock %}

{% block extra_modals %}
  {% include "album/_rename_track_modal.html" %}
  {% include "album/_delete_track_modal.html" %}
  {% include "album/_rename_album_modal.html" %}
  {% include "album/_delete_album_modal.html" %}
{% endblock %}